<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scraper de Noticias (Worker)</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 40px auto; }
    input, button { padding: 8px; font-size: 16px; margin-right: 5px; }
    #resultados { margin-top: 20px; }
    .nota { padding: 6px 0; border-bottom: 1px solid #ddd; }
  </style>
</head>
<body>
  <h1>Scraper de noticias (Worker)</h1>
  <p>Pegá la URL del sitio de noticias que quieras scrapear. Funciona solo con sitios que cargan titulares en el HTML inicial.</p>

  <input id="url" type="text" placeholder="https://www.ejemplo.com" style="width: 70%;" />
  <button onclick="scrapear()">Scrapear</button>
  <button onclick="exportCSV()">Exportar CSV</button>

  <h3 id="contador"></h3>
  <div id="resultados"></div>

<script>
let notasGlobal = [];

async function scrapear() {
  const url = document.getElementById('url').value.trim();
  const resultadosDiv = document.getElementById('resultados');
  const contador = document.getElementById('contador');
  resultadosDiv.innerHTML = '';
  contador.textContent = '';
  notasGlobal = [];

  if (!url) return alert('Pegá una URL');

  try {
    const proxyUrl = `https://curly-hill-d8ab.adiez.workers.dev/?url=${encodeURIComponent(url)}`;
    const respuesta = await fetch(proxyUrl);
    const html = await respuesta.text();

    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');

    const candidatos = [...doc.querySelectorAll('h1, h2, h3, article a')]
      .map(el => {
        if(el.tagName.toLowerCase() === 'a') {
          return { titulo: el.innerText.trim(), link: el.href };
        } else {
          const a = el.querySelector('a');
          return a ? { titulo: a.innerText.trim(), link: a.href } : null;
        }
      })
      .filter(n => n && n.titulo.length > 20);

    notasGlobal = candidatos;

    if(notasGlobal.length === 0) {
      contador.textContent = 'No se encontraron titulares en el HTML inicial. Es posible que el sitio use JavaScript para cargar noticias.';
    } else {
      contador.textContent = `Notas encontradas: ${notasGlobal.length}`;
      notasGlobal.forEach(n => {
        const div = document.createElement('div');
        div.className = 'nota';
        div.innerHTML = `<a href="${n.link}" target="_blank">${n.titulo}</a>`;
        resultadosDiv.appendChild(div);
      });
    }

  } catch (e) {
    console.error(e);
    alert('No se pudo scrapear la página. Verifica la URL o que el sitio permita fetch desde otros dominios.');
  }
}

function exportCSV() {
  if (notasGlobal.length === 0) return alert('No hay notas para exportar.');

  const csvContent = 'data:text/csv;charset=utf-8,' + notasGlobal.map(n => `"${n.titulo.replace(/"/g,'""')}","${n.link}"`).join('\n');
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement('a');
  link.setAttribute('href', encodedUri);
  link.setAttribute('download', 'notas_scrapeadas.csv');
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
</script>
</body>
</html>
